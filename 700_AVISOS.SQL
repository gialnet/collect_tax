-- -----------------------------------------------------
-- Euro. Revisado el 5-12-2001. Lucas Fernández Pérez 
-- No se han realizado cambios.
-- -----------------------------------------------------



CREATE OR REPLACE FUNCTION JEFE_ZONA(xZONA IN CHAR)
RETURN CHAR
AS
xUSUARIO CHAR(30);
BEGIN

-- AVERIGUAR QUIEN ES EL JEFE DE UNA ZONA

SELECT USUARIO INTO xUSUARIO FROM ZONAS WHERE ZONA=xZONA;

RETURN xUSUARIO;

END;
/

CREATE OR REPLACE FUNCTION GERENTE
RETURN CHAR
AS
xUSUARIO CHAR(30);
BEGIN

-- AVERIGUAR QUIEN ES EL GERENTE

SELECT MAX(USUARIO) INTO xUSUARIO FROM DATOSPERR;

RETURN xUSUARIO;

END;
/

-- Modificado: 04/03/2002 Lucas Fernández Pérez.
-- Se lee de la tabla de usuarios el IDEMBARGO para saber el usuario en Inmuebles y Vehiculos.
CREATE OR REPLACE PROCEDURE LISTADEAVISOS(
	xIDExpe IN INT, 
	xEXPE   IN CHAR,
	xUSUARIO IN CHAR,
	xAVISO IN CHAR, 
	xZONA CHAR)
AS

xUSUTRAMITE CHAR(30);
xTIPO CHAR(2);
xTEXTO VARCHAR2(250);
xIDEMBARGO INTEGER;

CURSOR cAVISO IS 
SELECT PERSONA,USUARIO FROM AQUIENAVISO
	WHERE AVISO=xAVISO;

BEGIN



SELECT TIPO,RTRIM(TEXTO) INTO xTIPO,xTEXTO FROM AVISOS
	WHERE AVISO=xAVISO;

xTEXTO:=xTEXTO || ' ' || xEXPE || ' ID: '|| TO_CHAR(xIDExpe);


-- AVISO PARA EL GESTOR DEL EXPEDIENTE
INSERT INTO AVISOS_USUARIOS (xTEXTO, USUARIO, AVISO) 
   VALUES (xTEXTO, xUSUARIO, xAVISO);

-- AVISO PARA EL GESTOR DEL TRÁMITE SI NO ES EL MISMO QUE EL EXPEDIENTE

IF xTIPO IN ('T1','T3','T4','T8') THEN
   IF xTIPO='T1' THEN
   	begin
	SELECT USUARIO INTO xUSUTRAMITE FROM EMBARGOS_CUENTAS 
		WHERE IDEXPE=xIDExpe;
	exception
		when no_data_found then
			xUSUTRAMITE:=null;
	end;
   END IF;

   IF xTIPO='T3' THEN
	begin
	SELECT USUARIO INTO xUSUTRAMITE FROM EMBARGOS_SALARIOS 
		WHERE IDEXPE=xIDExpe;
	exception
		when no_data_found then
			xUSUTRAMITE:=null;
	end;
   END IF;

   IF xTIPO='T4' THEN
	begin -- Leo el embargo, porque el expediente puede tener mas de un embargo.
	SELECT LAST_NUMERO INTO xIDEMBARGO FROM USUARIOS WHERE USUARIO=USER;
   	SELECT USUARIO INTO xUSUTRAMITE FROM EMBARGOS_INMUEBLES 
		WHERE ID=xIDEMBARGO;
	exception
		when no_data_found then
			xUSUTRAMITE:=null;
	end;
   END IF;

   IF xTIPO='T8' THEN
	begin -- Leo el embargo, porque el expediente puede tener mas de un embargo.
	SELECT LAST_NUMERO INTO xIDEMBARGO FROM USUARIOS WHERE USUARIO=USER;
   	SELECT USUARIO INTO xUSUTRAMITE FROM EMBARGOS_AUTOS 
		WHERE ID=xIDEMBARGO;
	exception
		when no_data_found then
			xUSUTRAMITE:=null;
	end;
   END IF;

   IF xUSUARIO<> xUSUTRAMITE THEN
      INSERT INTO AVISOS_USUARIOS (xTEXTO, USUARIO, AVISO) 
      VALUES (xTEXTO, xUSUTRAMITE, xAVISO);
   END IF;


END IF; -- xTIPO IN


-- COMPROBAR LA LISTA DE USUARIOS ADICIONALES A NOTIFICAR ESTE AVISO

FOR v_cAVISO IN cAVISO
LOOP

	IF v_cAVISO.PERSONA='GE' AND (GERENTE()<>xUSUARIO AND GERENTE()<>xUSUTRAMITE) THEN
   	   INSERT INTO AVISOS_USUARIOS (USUARIO, AVISO, xTEXTO) 
	   VALUES (GERENTE(), xAVISO, xTEXTO);
	END IF;

	IF v_cAVISO.PERSONA='JZ' AND 
		(JEFE_ZONA(xZONA)<>xUSUARIO AND JEFE_ZONA(xZONA)<>xUSUTRAMITE) THEN
   	   INSERT INTO AVISOS_USUARIOS (USUARIO, AVISO, xTEXTO) 
	   VALUES (JEFE_ZONA(xZONA), xAVISO, xTEXTO);
	END IF;

	IF v_cAVISO.PERSONA='OT' AND 
		(v_cAVISO.USUARIO<>xUSUARIO AND v_cAVISO.USUARIO<>xUSUTRAMITE) THEN
   	   INSERT INTO AVISOS_USUARIOS (USUARIO, AVISO, xTEXTO) 
	   VALUES (v_cAVISO.USUARIO, xAVISO, xTEXTO);
	END IF;



END LOOP;


END;
/


-- AÑADIR PERSONAS A LA LISTA DE AVISOS ADICIONALES

CREATE OR REPLACE PROCEDURE ADDAVISOEXTRA(
	xAVISO IN CHAR, 
	xPERSONA IN CHAR, 
	xUSUARIO IN CHAR)
AS
xAVISOAQ CHAR(3);
BEGIN

IF xPERSONA='OT' THEN
   begin
     SELECT AVISO INTO xAVISOAQ FROM AQUIENAVISO 
	WHERE AVISO=xAVISO
	AND PERSONA=xPERSONA
	AND USUARIO=xUSUARIO;
   exception
   When no_data_found then
      INSERT INTO AQUIENAVISO (AVISO, PERSONA, USUARIO)
	  VALUES (xAVISO, xPERSONA, xUSUARIO);
   end;
ELSE
   begin
     SELECT AVISO INTO xAVISOAQ FROM AQUIENAVISO 
	WHERE AVISO=xAVISO
	AND PERSONA=xPERSONA;
   exception
   When no_data_found then
      INSERT INTO AQUIENAVISO (AVISO, PERSONA)
	  VALUES (xAVISO, xPERSONA);
   end;
END IF;


END;
/

-- BORRAR PERSONAS A LA LISTA DE AVISOS ADICIONALES

CREATE OR REPLACE PROCEDURE DELAVISOEXTRA(
	xAVISO IN CHAR, 
	xPERSONA IN CHAR, 
	xUSUARIO IN CHAR)
AS
BEGIN


DELETE FROM AQUIENAVISO 
	WHERE AVISO=xAVISO
	AND PERSONA=xPERSONA
	AND USUARIO=xUSUARIO;


END;
/
